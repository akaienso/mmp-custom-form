<!-- NOTE: This form is used to sign up new members for RAGAS.online 
    using the iMembersDB membership management system. For version 
    history, development notes,and additional documentation, visit 
    https://github.com/memberminderpro/ragas.online

    For more information or support contact Member Minder Pro, LLC
    at support@memberminderpro.com or visit https://memberminderpro.com
 -->

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/fontawesome.min.css" rel="stylesheet" crossorigin="anonymous" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" crossorigin="anonymous"  />
<style>.entry{ height: 30px;} .error{ color: red} .TDData{ font-size: 13px; margin: 0px; padding: 0px;} .thc{ text-align: center;} .tdc{ text-align: center;} input, select{ border: 1px solid #444; border-radius: 4px; height: 22px;} input.error{ border: 2px solid red;} .error{ padding-left: 10px; color: red; font-size: 11px; font-family: Tahoma, Geneva, sans-serif; font-weight: bold;} .membercategorywrap{ min-width: 200px; float: left; padding-bottom: 3px; white-space: nowrap; margin-right: 10px;} .star{ color: red; font-weight: bold;}</style>
<div id="Step1">
    <h3>Join Us!</h3>
    <form id="form" name="form" Action="https://www.emembersdb.com/nm/custom.cfm" method="Post">
        <!-- These parameters MUST be changed for each account membership application -->
        <input type="hidden" name="AccountID" value="10621" id="AccountID" /> <!-- Account -->
        <input type="hidden" name="APIKey" value="72a929802e4f44a0beea7c69aaf795da" id="APIKey" /> <!-- APIKey -->
        <input type="hidden" name="BID" value="1040" id="BID" /> <!-- Account -->
        <input type="hidden" name="MemberID" value="0" /> <!-- Default MemberID -->
        <input type="hidden" name="UserID" value="0" id="UserID" /><!-- UserID -->
        <input type="hidden" name="AddressTypeID" value="1" /> <!-- Default Address type -->
        <input type="hidden" name="EmailTypeID" value="1" /> <!-- Default Email type -->
        <input type="hidden" name="UserStatusCode" value="P" /> <!-- DefaultUser Status -->
        <input type="hidden" name="MemberTypeID" value="587" id="MemberTypeID" /> <!-- Default MemberTypeID -->
        <!-- <input type="hidden" name="AccountEmail" value="membership@RAGAS.online" id="AccountEMail" /> Who gets the application -->
        <input type="hidden" name="AccountEmail" value="rob.moore@memberminderpro.com" id="AccountEMail" />
        <input id="fkclubname" type="hidden" name="fkclubname" value=""> <!--- FK reference in iMembersDB Region(Club) tab --->
        <input id="fkdistrict" type="hidden" name="fkdistrict" value="0"> <!--- FK reference in iMembersDB Region(Club) tab --->
        <input id="Region" type="hidden" name="Region" value="0">
        <input id="zonename" type="hidden" name="zonename" value="">
        <input id="ClubID" type="hidden" name="ClubID" value="989153">

        <div id="PrintContent">
            <table border="0" cellpadding="3" cellspacing="0">
                <tbody>
                    <tr>
                        <td align="center">
                            <span style="font-size:24px; font-family:Tahoma, Geneva, sans-serif; font-weight:bold;">YES! I would like to join RAGAS</span><br>
                            <span style="font-size:14px; font-family:Tahoma, Geneva, sans-serif; font-weight:bold;">(Information provided will be used strictly for RAGAS use unless otherwise instructed)<br />
                                <!--- <span style="font-size:14px;font-family:Tahoma, Geneva, sans-serif;font-weight:bold"><i>(If you are a returning member please log into your account to renew your membership.)</i> <a href="http://www.imembersdb.com" target="_blank" rel="noopener">iMembersDB Login</a> </span><br /> --->
                            </span>
                            <br />
                        </td>
                    </tr>
                </tbody>
            </table>

            <table border="0" cellpadding="3" cellspacing="0">
                <tbody>
                    <tr>
                        <td align="center">
                            <div>
                                <span style="font-size:13px; font-family:Tahoma, Geneva, sans-serif;font-weight:normal;"><u><em>Applicants are asked to complete the following information.</em></u> Starred items(*) are required.</span><br />
                                <span style="font-size:13px; font-family:Tahoma, Geneva, sans-serif;font-weight:normal;">After completing this form, click ‘Submit’.
                                    A copy of this application will be emailed to you. Or you can also print this form and mail it to the address below.
                                </span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <br />
            <table border="0" cellpadding="3" cellspacing="0" style="padding-top:12px">
                <tbody>
                    <tr>
                        <td align="left"><span style="font-size:14px; font-family:Tahoma, Geneva, sans-serif; font-weight:bold;color: #FF0000;">Member Information: </span></td>
                    </tr>
                </tbody>
            </table>

            <table border="0" cellpadding="0" cellspacing="0">
                <tbody>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Member Type: </td>
                        <td class="TDData">
                            <select id="MCY" name="MCY" style="width: 350px; height: 30px; color: #444" class="TxtIn">
                                <option value="588|75|5"> 5-Year Membership ($75.00 USD)</option>
                                <option value="587|30|1"> 1-Year Annual ($30.00 USD)</option>
                                <option value="589|15|1"> 1-Year Rotaractor/Peace Fellow ($15.00 USD)</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> First Name: </td>
                        <td class="TDData"><input class="entry" id="FirstName" type="text" maxlength="32" name="FirstName" value="" onkeypress="return noEnter(event)" required size="32" placeholder="First Name" /></td>
                    </tr>

                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Last Name: </td>
                        <td class="TDData"><input class="entry" id="LastName" type="text" maxlength="32" name="LastName" value="" style="height: 25px;" onkeypress="return noEnter(event)" required size="32" placeholder="Last Name" /></td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Email Address </td>
                        <td class="TDData"><input class="entry" id="Email" type="text" maxlength="64" name="email" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="32" required placeholder="EMail Address" />
                            <div id="EMailDiv" style="display: none; color: red">This email is already in the system. Please email membership at membership@RAGAS.org to change your membership type.</div>
                        </td>
                    </tr>

                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Are you a: </td>
                        <td class="TDData">
                            <select id="fkclubtype" name="fkclubtype" style="width: 350px; height: 30px; color: #444" class="TxtIn">
                                <option value="Rotary Club"> Rotarian</option>
                                <option value="Rotaract Club"> Rotaractor</option>
                                <option value="Non-Rotarian"> Non-Rotarian / Peace Fellow</option>
                            </select>
                            <input id="fkmembertype" type="hidden" name="fkmembertype" value="Active"> <!--- FK reference in iMembersDB Region(Club) tab --->
                        </td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Club Country: </td>
                        <td class="TDData">
                            <select id="fkcountry" name="fkcountry" style="width: 300px;" class="TxtIn CountryLookup"> </select>
                        </td>
                    </tr>
                    <tr id="staterow">
                        <td class="TDData" width="170"><span class="star">*</span> State/Province: </td>
                        <td class="TDData">
                            <select id="stateprov" name="stateprov" style="width: 300px;" class="TxtIn StateProvLookup"></select>
                            <input id="fkstateprov" type="hidden" name="fkstateprov" value=""> <!--- FK reference in iMembersDB Region(Club) tab (not currently used) --->
                        </td>
                    </tr>
                    <tr class="hide9">
                        <td class="TDData" width="170"><span style="color: red; font-weight: bold;">*</span> Club Name: </td>
                        <td class="TDData">
                            <select id="clubname" type="text" name="clubname" style="width: 400px;" class="TxtIn ClubLookupInZone"></select>
                            <div id="ClubLocDiv"></div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <table border="0" cellpadding="0" cellspacing="0" style="padding-top:12px">
                <tbody>
                    <tr>
                        <td align="left"><span style="font-size:14px; font-family:Tahoma, Geneva, sans-serif; font-weight:bold; color: #FF0000;">Billing Address: </span></td>
                    </tr>
                </tbody>
            </table>

            <table border="0" cellpadding="3" cellspacing="0">
                <tbody>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> Address1: </td>
                        <td class="TDData"><input class="entry" id="Address1" type="text" maxlength="50" name="Address1" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="50" type="text" value="" required placeholder="Street Address" /> (Address)</td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170">Address2: </td>
                        <td class="TDData"><input class="entry" id="Address2" type="text" maxlength="50" name="Address2" style="height: 25px;" onkeypress="return noEnter(event)" size="50" placeholder="Ste / Suite" /> (Ste/Suite)</td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170"><span class="star">*</span> City: </td>
                        <td class="TDData"><input class="entry" id="City" type="text" maxlength="50" name="City" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="50" required placeholder="City" /></td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170">State Code: </td>
                        <td class="TDData"><input class="entry" id="StateCode" type="text" maxlength="3" name="StateCode" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="3" /></td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170">Province: </td>
                        <td class="TDData"><input class="entry" id="ProvOrOther" type="text" maxlength="20" name="ProvOrOther" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="20" placeholder="Province" /></td>
                    </tr>
                    <tr>
                        <td class="TDData" width="170">Country Code: </td>
                        <td class="TDData">
                            <input class="entry" id="CountryCode" type="text" maxlength="3" name="CountryCode" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="3" required />
                            <input class="entry" id="CountryName" type="hidden" maxlength="3" name="CountryName" value="" />
                        </td>
                    </tr>
                    <tr class="hide25">
                        <td class="TDData" width="170"><span class="star">*</span>Postal Code: </td>
                        <td class="TDData"><input class="entry" id="PostalZip" type="text" maxlength="12" name="PostalZip" value="" style="height: 25px;" onkeypress="return noEnter(event)" size="12" required placeholder="Zip / Postal Code" /></td>
                    </tr>
                    <tr class="spam-handler">
                        <td class="TDData" colspan="2">
                            
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div>
            <P> RAGAS and our membership management system vendor, Member Minder Pro, LLC, dba iMembersDB, is collecting your personal information in order to process your online application for RAGAS membership. The Registrant authorizes RAGAS to collect and use personal information about the Registrant for the purpose of receiving communications and the purposes described in the RAGAS policies relating to data privacy - RAGAS.online/privacy. Permission may be withdrawn at any time by contacting RAGAS’s Privacy Officer at privacy@ragas.online. Please check the "I Consent" checkbox below to allow us to collect, use, and disclose your personal information as described above.</P>
            <p><input id="Consent" type="checkbox" name="consent" value="1"> <strong>I Consent</strong></p>
        </div>
        <P class="noprint"><a href="" id="prtapp">Click here</a> to print.<p>
        <div class="captcha-send" style="display: none;">
            <div class="h-captcha" data-sitekey="1d208c51-6553-481d-bc8b-e021285bd77e" data-callback="onCaptchaSuccess"></div>
            <p><input id="Send" type="button" name="Send" value="Submit Application" class="btn btn-warning noprint" style="display: none;" disabled></p>
        </div>
    </form>
</div>

<div id="Step2" style="display:none;">
    <h3>Problem!</h3>
    <P>There was a system error creating your new membership. Please contact support to resolve this issue.</P>
    <P><BR />
    <div id="ErrorDiv"></div>
    </P>
    <BR>
</div>

<div id="wait" style="display: none;">
    <div style="margin-top:25px;" align="center">
        <div style="width: auto">
            <img src="https://www.emembersdb.com/Portal/images/tm.png" height="50"><BR>
            <h4 style="font-family:Tahoma, Geneva, sans-serif">Please wait... We are taking you over to Team Merchant</h4>
            <BR>
            <img src="https://www.emembersdb.com/images/loading.gif" height="30">
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js" defer></script>
<script>
    function getQueryParams(qs) {
        let params = new URLSearchParams(qs);
        let result = {};
        params.forEach((value, key) => {
            result[key] = value;
        });
        return result;
    }

    function noEnter(e) {
        let keycode = e.which || e.keyCode; // Modern browsers support e.which
        if (keycode === 13) { // 13 is the Enter key
            e.preventDefault(); // Prevent form submission
        }
    }

    jQuery(document).ready(function($) {
        let captchaSolved = false;

        const $emailDiv = $("#EMailDiv");
        const $send = $("#Send");
        const $hcSend = $(".captcha-send");

        // Function to handle showing/hiding captcha and submit button based on consent
        function toggleCaptchaAndButton() {
            if ($("#Consent").is(":checked")) {
                $(".captcha-send").show(); // Show captcha
                if (captchaSolved) {
                    $("#Send").show().prop("disabled", false); // Show and enable submit button if captcha is solved
                } else {
                    $("#Send").hide(); // Otherwise, keep the submit button hidden
                }
            } else {
                $(".captcha-send").hide(); // Hide captcha and submit button if consent is not checked
                $("#Send").hide();
            }
        }

        // Consent checkbox change event
        $("#Consent").change(function() {
            toggleCaptchaAndButton(); // Call the function to toggle captcha and button based on consent
        });

        // Define the onCaptchaSuccess function to handle captcha success
        window.onCaptchaSuccess = function(token) {
            captchaSolved = true; // Set flag to true when captcha is solved
            if ($("#Consent").is(":checked")) {
                $("#Send").show().prop("disabled", false); // Show and enable submit button
            }
        };

        $("#prtapp").click(function() {
            console.log("print")
            $("#PrintContent").printThis();
            return false;
        });

        $send.click(function(event) {
            event.preventDefault(); // Prevent the form from submitting via the browser

            if (!captchaSolved) {
                alert("Please complete the captcha challenge.");
                return;
            }

            // Extract MemberTypeID from the selected option and update the hidden field
            let id = $("#MCY").val(); // Get MemberTypeID|Cost|Years
            let arrTmp = id.split("|"); // Use "|" to separate
            let mtid = arrTmp[0]; // Get the 1st part - membertypeid
            $("#MemberTypeID").val(mtid); // Set the membertypeid in the form

            // Serialize form data after updating the hidden field
            let formData = $("#form").serialize(); // Note the change to serialize()

            // Add action for WP AJAX
            formData += '&action=verify_hcaptcha_and_submit'; // Append the action to the serialized data string

            $.ajax({
                url: '/wp-admin/admin-ajax.php', // Direct path to admin-ajax.php
                type: 'POST',
                data: formData,
                success: function(response) {
                    if(response.success) {
                        alert(response.data.message);
                        // Optionally, redirect the user or display a success message
                    } else {
                        alert(response.data.message); // Captcha verification failed or other error
                    }
                },
                error: function() {
                    alert("There was an error processing the form. Please try again.");
                }
            });
        });

        $("#Email").change(function() {
            console.log("Handler for email .change() called.");
            $.ajax({
                url: 'https://www.emembersdb.com/Lookup/EMailCheck.cfm',
                type: "POST",
                dataType: 'json',
                data: {
                    AccountID: $("#AccountID").val(),
                    Email: $(this).val().trim(),
                    IsActive: 'Y' // Search for active subscriptions
                }
            }).done(function(data) {
                console.log(data)
                if (data == 1) {
                    $emailDiv.show();
                    $emailDiv.html(`This email is already in the system associated with a membership.Please email membership at ${$("#AccountEMail").val()} to change your membership type.`);
                    $hcSend.hide();
                    console.log("EMail found")
                } else {
                    $emailDiv.hide();
                    console.log("EMail NOT found")
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $emailDiv.html("Error checking email. Please try again.").show();
                console.error("Email change AJAX request failed: " + textStatus, errorThrown);
            });
        });

        $("#fkclubtype").change(function() {
            console.log("Handler for membertype .change() called.");
            let mt = $(this).val()
            console.log(mt)
            switch (mt) {
                case 'Rotary Club':
                    $(".hide9").show();
                    $("#fkmembertype").val("Active");
                    break;
                case 'Rotaract Club':
                    $(".hide9").show();
                    $("#fkmembertype").val("Rotaractor");
                    break;
                case 'Non-Rotarian':
                    $(".hide9").hide();
                    $("#fkmembertype").val("Non-Rotarian");
                    break;
            }
        });

        $('.CountryLookup').on('select2:select', function(e) {
            let data = e.params.data;
            console.log(data)
            console.log("id=" + data.id) // countrycode
            console.log("country=" + data.text) // countryname
            console.log("cnt=" + data.cnt) // count of states
            $("#CountryCode").val(data.id) // countrycode
            if (data.cnt == 0)
                $("#staterow").hide();
            else
                $("#staterow").show();
        });

        $('.CountryLookup').select2({
            placeholder: 'Select Country',
            ajax: {
                url: 'https://www.emembersdb.com/Lookup/FKRotaryCountry.cfm',
                type: "POST",
                dataType: 'json',
                quietMillis: 100,
                data: function(params) {
                    var query = {
                        term: params.term
                    }
                    return query;
                }
            },
            results: function(data) {
                results = [];
                $.each(data, function(index, item) {
                    results.push({
                        id: item.id,
                        text: item.text
                    });
                });
                return {
                    results: results
                };
            },
            createTag: function(params) {
                return {
                    id: params.term,
                    text: params.term,
                    newOption: true
                }
            }
        });

        $('.StateProvLookup').on('select2:select', function(e) {
            let data = e.params.data;
            console.log(data)
            console.log("id=" + data.id) // statecode
            console.log("StateProv=" + data.text) // StateProv
            $("#StateCode").val(data.statecode) // statecode
            $("#fkstateprov").val(data.text) // StateProv
            $("#ProvOrOther").val(data.province) // Province
        });

        $('.StateProvLookup').select2({
            placeholder: 'Select State or Province',
            tags: true,
            ajax: {
                url: 'https://www.emembersdb.com/Lookup/FKRotaryStateProv.cfm',
                // url: 'http://emdb.com/Lookup/FKRotaryStateProv.cfm',
                type: "POST",
                dataType: 'json',
                quietMillis: 100,
                data: function(params) {
                    var country = $("#fkcountry").val(); // countrycode
                    console.log("country=" + country);
                    if (country.length == 0) {
                        alert("select Country first!");
                        return '[]';
                    }
                    var query = {
                        countrycode: country,
                        AccountID: $("#AccountID").val(),
                        term: params.term
                    }
                    return query;
                }
            },
            results: function(data) {
                results = [];
                $.each(data, function(index, item) {
                    results.push({
                        id: item.id,
                        text: item.text
                    });
                });
                return {
                    results: results
                };
            },
            createTag: function(params) {
                return {
                    id: params.term,
                    text: params.term,
                    newOption: true
                }
            }
        });

        $('.ClubLookupInZone').on('select2:select', function(e) {
            console.log("ClubLookup change")
            let data = e.params.data;
            console.log(data)

            $("#fkdistrict").val(data.districtid) // DistrictID
            $("#zonename").val(data.zonename) // zonename
            $("#ClubID").val(data.id) // iMembersDB ClubID
            $("#fkclubname").val(data.text) // fkclubNmae
            $("#ClubLocDiv").html("District: " + data.districtid + "   RAGAS zone: " + data.zonename)

        });

        $('.ClubLookupInZone').select2({
            placeholder: 'Rotary Club',
            tags: true,
            ajax: {
                url: 'https://www.emembersdb.com/Lookup/FKRotaryClubInZone.cfm',
                type: "POST",
                dataType: 'json',
                quietMillis: 100,
                data: function(params) {
                    let countrycode = $(".CountryLookup option:selected").val();
                    let statecode = $("#StateCode").val();
                    let orgtype = $("#fkclubtype").val();
                    console.log("countrycode=" + countrycode + " statecode=" + statecode + " orgtype=" + orgtype);
                    let query = {
                        AccountID: $("#AccountID").val(),
                        countrycode: countrycode,
                        statecode: statecode,
                        orgtype: orgtype,
                        term: params.term
                    }
                    return query;
                }
            },
            results: function(data) {
                results = [];
                $.each(data, function(index, item) {
                    results.push({
                        id: item.id,
                        text: item.text
                    });
                });
                return {
                    results: results
                };
            },
            createTag: function(params) {
                return {
                    id: params.id,
                    text: params.text,
                    newOption: true
                }
            }
        });

        $("#paycc").click(function() {
            let f = $("#form2").serialize();
            const url = 'https://emembersdb.com/Portal/pbcc.cfm';

            try {
                $('#form2').attr('action', url);
                $('#form2').submit();
            } catch (error) {
                alert("Could not submit form.")
            }
        });

        $("#payck").click(function() {
            let f = $("#form2").serialize();
            const url = 'https://emembersdb.com/Portal/pbck.cfm';

            try {
                $('#form2').attr('action', url);
                $('#form2').submit();
            } catch (error) {
                alert("Could not submit form.")
            }
        });

    });
</script>
<script src="https://js.hcaptcha.com/1/api.js" async defer></script>
